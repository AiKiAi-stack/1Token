name: Release CLI Tool

on:
  push:
    tags:
      - 'v*'  # Trigger on tags like v1.0.0

permissions:
  contents: write  # Required to create releases

jobs:
  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Get current tag
          TAG=${GITHUB_REF#refs/tags/}
          
          # Get commits since last tag
          git fetch --all
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ "$LAST_TAG" != "$TAG" ] && [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline "$LAST_TAG..$TAG" 2>/dev/null || git log --oneline "$TAG~..$TAG" 2>/dev/null)
          elif git rev-list --count HEAD --max-count=10 2>/dev/null > /dev/null; then
            # If no previous tag, grab recent commits
            COMMITS=$(git log --oneline -20)
          else
            COMMITS="Initial release"
          fi
          
          # Get contributors
          CONTRIBUTORS=$(git log --oneline "$LAST_TAG..$TAG" --pretty=format:"%an" 2>/dev/null | sort | uniq -c | sort -nr | awk '{print $2}')
          
          # Create release notes content
          CONTENT="# Release Notes for $TAG\n\n"
          
          if [ -n "$COMMITS" ] && [ "$COMMITS" != "Initial release" ]; then
            CONTENT="$CONTENT## What's Changed\n"
            echo "$COMMITS" | while IFS= read -r line; do
              if [ -n "$line" ]; then
                CONTENT="$CONTENT- $(echo $line | cut -d' ' -f2-)\n"
              fi
            done
            CONTENT="$CONTENT\n"
          else
            CONTENT="$CONTENT## Initial Release\n"
            CONTENT="$CONTENT- Initial CLI tool\n\n"
          fi
          
          # Add contributors
          if [ -n "$CONTRIBUTORS" ]; then
            CONTENT="$CONTENT## Contributors\n"
            echo "$CONTRIBUTORS" | while read -r line; do
              if [ -n "$line" ]; then
                CONTENT="$CONTENT- @$line\n"
              fi
            done
            CONTENT="$CONTENT\n"
          fi
          
          CONTENT="$CONTENT## Artifacts\n"
          CONTENT="$CONTENTThis release includes pre-compiled binaries for:\n"
          CONTENT="$CONTENT- Windows (x64)\n"
          CONTENT="$CONTENT- macOS (Intel/Apple Silicon)\n"
          CONTENT="$CONTENT- Linux (x64)\n"
          
          # Escape quotes and create output variable
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CONTENT" 2>/dev/null >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.content }}
          draft: false
          prerelease: false

  # Build for each platform
  build:
    name: Build (${{ matrix.os }}-${{ matrix.arch }})
    needs: create_release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            platform: linux
            target: linux-x64
            output_name: 1token
          - os: windows-latest
            arch: x64
            platform: windows
            target: win-x64
            output_name: 1token.exe
          - os: macos-latest
            arch: x64
            platform: darwin
            target: macos-x64
            output_name: 1token
          - os: macos-latest
            arch: arm64
            platform: darwin
            target: macos-arm64
            output_name: 1token
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          pnpm db:generate
          pnpm cli:build
          
      - name: Install pkg globally
        run: npm install -g pkg
        
      - name: Install OS specific dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libreadline-dev libffi-dev wget
          
      - name: Build executable with pkg
        run: |
          # Create a simple JavaScript entry point
          echo 'const { spawn } = require("child_process");
          const path = require("path");
          
          // Resolve the absolute path to the CLI
          const cliPath = path.resolve(__dirname, "dist", "index.js");
          
          // Spawn Node.js process with the CLI
          const child = spawn("node", [cliPath, ...process.argv.slice(2)], {
            stdio: [process.stdin, process.stdout, process.stderr]
          });
          
          child.on("close", (code) => {
            process.exit(code);
          });' > cli-entry.js
          
          # Use pkg to create standalone executable
          pkg cli-entry.js \
            --targets node18-${{ matrix.platform }}-${{ matrix.arch }} \
            --output dist/${{ matrix.output_name }}
            
      - name: Create archive
        shell: bash
        run: |
          VERSION=${{ github.ref_name }}
          
          # Create archive using platform-specific tool
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            # ZIP on Windows
            7z a "1token-${VERSION}-${{ matrix.target }}.zip" "dist/"
            echo "archive_name=1token-${VERSION}-${{ matrix.target }}.zip" >> $GITHUB_ENV
          else
            # Tar-gz on Unix-like systems
            tar -czf "1token-${VERSION}-${{ matrix.target }}.tar.gz" -C dist .
            echo "archive_name=1token-${VERSION}-${{ matrix.target }}.tar.gz" >> $GITHUB_ENV
          fi

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.upload_url }}
          asset_path: ./${{ env.archive_name }}
          asset_name: ${{ env.archive_name }}
          asset_content_type: application/octet-stream
